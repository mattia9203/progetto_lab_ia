# -*- coding: utf-8 -*-
"""Dataset.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/16UhWHBFNPRL7eGG0vLZhPn7onvbVtQWO

#Creazione classe dataset
"""

import torch
import numpy as np
import pandas as pd
import fiona
import os


import rasterio
import geopandas as gpd
import matplotlib.pyplot as plt


from torch.utils.data import Dataset
import json
from shapely.geometry import shape
from rasterio.features import rasterize

class Dataset(Dataset):
  def __init__(self,root,transform = None):
    self.root = root  #directory radice
    self.transform = transform
    self.zones = self.load_zones()


  def load_zones(self):
    zones = {}       #dizionario dove ad ogni chiave corrispondono
    #itero attraverso le cartelle per trovare percorsi delle immagini
    for zone in os.listdir(self.root):
      zone_path = os.path.join(self.root,zone)
      if os.path.isdir(zone_path):
        zones[zone] = self.load_images_and_labels(zone_path)
    return zones

  def load_images_and_labels(self,zone_path):
    image_label_pairs = []
    if os.path.isdir(zone_path):
      images_dir = os.path.join(zone_path, 'images_masked')     #directory con immagini
      labels_dir = os.path.join(zone_path, 'labels_match')      #directory con labels
      if os.path.exists(images_dir) and os.path.exists(labels_dir):
        for image_file in os.listdir(images_dir):
          if (image_file.endswith('.tif')):
            image_path = os.path.join(images_dir,image_file)
            label_file = os.path.splitext(image_file)[0] + '_Buildings.geojson'
            label_path = os.path.join(labels_dir,label_file)

            if os.path.exists(label_path):
              image_label_pairs.append((image_path,label_path))
    return image_label_pairs


  def __len__(self):
    return sum(len(pairs) for pairs in self.zones.values())


  def __getitem__(self,idx):
    image_mask_list = []
    for x in self.zones[idx]:
      image_path,label_path = x

      with rasterio.open(image_path) as src:
        image = src.read().astype(np.float32)
        out_shape = (src.height,src.width)
        transform = src.transform

        with open(label_path) as label:
          geojson = json.load(label)

        if 'features' in geojson and len(geojson['features']) > 0:
          gdf = gpd.GeoDataFrame.from_features(geojson['features'])
          if not gdf.empty and gdf.geometry.notnull().any():

            mask = rasterize( [(geom,1) for geom in gdf.geometry], out_shape=out_shape,transform=transform,fill=0,dtype='uint8')
          else:
            mask = np.zeros(out_shape,dtype='uint8')
        else:
          mask = np.zeros(out_shape,dtype='uint8')

        if self.transform:
          image = self.transform(image)
          mask = self.tranform(mask)

        image_mask_list.append((image,mask))
    return image_mask_list

train_dataset = Dataset("/content/drive/MyDrive/Progetto_laboratorio/Dataset/train")
test_dataset = Dataset("/content/drive/MyDrive/Progetto_laboratorio/Dataset/test")
val_dataset = Dataset("/content/drive/MyDrive/Progetto_laboratorio/Dataset/validation")
